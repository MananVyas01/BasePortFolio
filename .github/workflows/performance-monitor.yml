name: Performance Monitor

on:
  schedule:
    - cron: '0 0 * * 1' # Weekly on Monday
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  lighthouse:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: npm install -g lighthouse
      
    - name: Run Lighthouse
      run: |
        lighthouse https://mananyvas01.github.io/BasePortFolio/ \
          --output json \
          --output-path ./lighthouse-results.json \
          --chrome-flags="--headless --no-sandbox"
          
    - name: Parse Results
      id: lighthouse
      run: |
        PERFORMANCE=$(cat lighthouse-results.json | jq '.categories.performance.score * 100')
        ACCESSIBILITY=$(cat lighthouse-results.json | jq '.categories.accessibility.score * 100')
        BEST_PRACTICES=$(cat lighthouse-results.json | jq '.categories["best-practices"].score * 100')
        SEO=$(cat lighthouse-results.json | jq '.categories.seo.score * 100')
        
        echo "performance=$PERFORMANCE" >> $GITHUB_OUTPUT
        echo "accessibility=$ACCESSIBILITY" >> $GITHUB_OUTPUT
        echo "best_practices=$BEST_PRACTICES" >> $GITHUB_OUTPUT
        echo "seo=$SEO" >> $GITHUB_OUTPUT
        
    - name: Create Issue if Performance is Low
      if: ${{ steps.lighthouse.outputs.performance < 80 }}
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: '🐌 Performance Alert: Portfolio Speed Issues',
            body: `## Performance Report
            
            ⚠️ **Performance Score: ${{ steps.lighthouse.outputs.performance }}/100**
            
            - **Accessibility**: ${{ steps.lighthouse.outputs.accessibility }}/100
            - **Best Practices**: ${{ steps.lighthouse.outputs.best_practices }}/100
            - **SEO**: ${{ steps.lighthouse.outputs.seo }}/100
            
            ### Next Steps
            - [ ] Optimize images
            - [ ] Minify CSS/JS
            - [ ] Check for unused code
            - [ ] Improve loading times
            
            *Generated automatically by GitHub Actions*`,
            labels: ['performance', 'bug', 'automated']
          });
          
    - name: Comment on PR if exists
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## 🚀 Lighthouse Performance Report
            
            | Metric | Score |
            |--------|-------|
            | Performance | ${{ steps.lighthouse.outputs.performance }}/100 |
            | Accessibility | ${{ steps.lighthouse.outputs.accessibility }}/100 |
            | Best Practices | ${{ steps.lighthouse.outputs.best_practices }}/100 |
            | SEO | ${{ steps.lighthouse.outputs.seo }}/100 |`
          });
